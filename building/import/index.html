<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.42.1" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  
  <title>Data Import &middot; BMEG</title>
  

  
  <link rel="stylesheet" href="https://bmeg.github.io/css/poole.css">
  <link rel="stylesheet" href="https://bmeg.github.io/css/darcula.css">
  <link rel="stylesheet" href="https://bmeg.github.io/css/syntax.css">
  <link rel="stylesheet" href="https://bmeg.github.io/css/theme.css">
  <link rel="stylesheet" href="https://bmeg.github.io/css/funnel.css">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=PT+Sans:400,400italic,700">

  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://bmeg.github.io/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="https://bmeg.github.io/favicon.png">

  <script src="https://bmeg.github.io/js/highlight.pack.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

</head>
<body>

  <div class="global-header">
    <div class="global-header-container">
      <div class="global-header-home">
        <a href="http://bmeg.io"><h1>BMEG</h1></a>
      </div>
      <ul class="global-header-nav">
          <li><a href="https://bmeg.github.io/queries/">Make Queries</a></li>
          <li><a href="https://bmeg.github.io/building/">Build Graph</a></li>
          <li><a target="_blank" href="https://github.com/bmeg/">GitHub</a></li>
          <li><a target="_blank" href="https://gitter.im/bmeg/">Chat</a></li>
        </ul>
      <div class="global-header-ohsucb">
        <a href="https://www.ohsu.edu/compbio/"><h2>OHSU Comp Bio</h2></a>
      </div>
    </div>
  </div>


<div class="content section group">

  <div class="sidebar col span_3_of_12">
    <ul class="sidebar-nav">
      
      
        
        <li>
          
          <span class="intermediate"><a href="https://bmeg.github.io/queries/"
             class="sidebar-nav-item "
          >Queries</a></span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/install/"
                   class="sidebar-nav-item "
                >Install</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/getting_started/"
                   class="sidebar-nav-item "
                >Getting Started</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/traversal/"
                   class="sidebar-nav-item "
                >Traversal</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/kaplan_meier/"
                   class="sidebar-nav-item "
                >Kaplan Meier Curves</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/matrix/"
                   class="sidebar-nav-item "
                >Matrix</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/queries/drug_response/"
                   class="sidebar-nav-item "
                >Drug Response</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <span class="intermediate"><a href="https://bmeg.github.io/building/"
             class="sidebar-nav-item "
          >Building Graph</a></span></li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/building/schema/"
                   class="sidebar-nav-item "
                >Schema</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/building/import/"
                   class="sidebar-nav-item  active"
                >Data Import</a></li>
            </ul>
          </li>
          
          <li>
            <ul class="sidebar-nav sidebar-nav-nested">
              <li>
                <a href="https://bmeg.github.io/building/protograph/"
                   class="sidebar-nav-item "
                >Protograph</a></li>
            </ul>
          </li>
          
          
        
        <li>
          
          <a href="https://bmeg.github.io/system/"
             class="sidebar-nav-item "
          >System</a></li>
          
        
        <li>
          
          <a href="https://bmeg.github.io/updates/"
             class="sidebar-nav-item "
          >Updates</a></li>
          
        
      
    </ul>
  </div>

  <div class="main col span_8_of_12">
    

<h1 id="data-import">Data Import</h1>

<p>All data import is done via <a href="http://www.commonwl.org">CWL</a> wrapped docker containers.</p>

<h1 id="write-the-schema">Write the schema</h1>

<p>From <a href="https://github.com/biostream/phenotype-schema/blob/master/phenotype.proto">BMEG Phenotype Schema</a></p>

<pre><code>message GeneOntologyTerm {
  string id = 1;
  string name = 2;
  string namespace = 3;
  string definition = 4;
  string comment = 5;
  repeated string synonym = 6;
  repeated string is_a = 7;
  repeated string alt_id = 8;
  repeated string subset = 9;
  repeated string xref = 10;
  bool is_obsolete = 11;
  repeated string consider = 12;
}
</code></pre>

<h1 id="create-python-code-based-on-the-schema">Create Python code based on the schema</h1>

<pre><code>protoc \
-I . -I ../ga4gh-schemas/src/main/proto/ \
--python_out=../ \
phenotype.proto
</code></pre>

<h2 id="write-a-converter-script">Write a converter script</h2>

<pre><code>#!/usr/bin/env python

import re
import sys
import json
import phenotype_pb2
from google.protobuf import json_format

re_section = re.compile(r'^\[(.*)\]')
re_field = re.compile(r'^(\w+): (.*)$')

def obo_parse(handle):

    rec = None
    for line in handle:
        res = re_section.search(line)
        if res:
            if rec is not None:
                yield rec
            rec = None
            if res.group(1) == &quot;Term&quot;:
                rec = {&quot;type&quot;:res.group(1)}
        else:
            if rec is not None:
                res = re_field.search(line)
                if res:
                    key = res.group(1)
                    val = res.group(2)
                    val = val.split(&quot; ! &quot;)[0]
                    if key in rec:
                        rec[key].append(val)
                    else:
                        rec[key] = [val]

    if rec is not None:
        yield rec

def unquote(s):
    res = re.search(r'&quot;(.*)&quot;', s)
    if res:
        return res.group(1)
    return s

def message_to_json(message):
    msg = json_format.MessageToDict(message, preserving_proto_field_name=True)
    return json.dumps(msg)

if __name__ == &quot;__main__&quot;:

    with open(sys.argv[1]) as handle:
        for rec in obo_parse(handle):
            go = phenotype_pb2.GeneOntologyTerm()
            go.id = rec['id'][0]
            go.name = rec['name'][0]
            go.namespace = rec['namespace'][0]
            go.definition = unquote(rec['def'][0])
            if 'synonym' in rec:
                for i in rec['synonym']:
                    go.synonym.append(unquote(i))
            if 'is_a' in rec:
                for i in rec['is_a']:
                    go.is_a.append(i)
            if 'xref' in rec:
                for i in rec['xref']:
                    go.xref.append(i.split(&quot; &quot;)[0])
            print message_to_json(go)
</code></pre>

<h2 id="declare-docker">Declare Docker</h2>

<pre><code>FROM python:2.7
RUN pip install protobuf
COPY *.py /opt/
COPY ga4gh/*.py /opt/ga4gh/
</code></pre>

<h2 id="write-cwl-wrapper">Write CWL Wrapper</h2>

<pre><code>
cwlVersion: v1.0
class: CommandLineTool
hints:
  DockerRequirement:
    dockerPull: go-transform:latest

baseCommand:
  - python
  - /opt/go_obo2schema.py

inputs:
  OBO:
    type: File
    inputBinding:
      position: 1

outputs:
  GO_JSON:
    type: stdout

stdout: go.json
</code></pre>

  </div>

</div>
</body>
</html>
